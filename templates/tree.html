<!doctype html>
<html lang="en">
    <head>
        <title>SkillTree</title>
        {{ template "header" }}
        <!-- custom css -->
        <link rel="stylesheet" href="/static/main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="columns">
                {{ template "sidebar" .Page }}
                <main id="main_tree" class="column col-10 col-gapless container tree">
                    <header class="navbar tree-nav">
                        <section class="navbar-section">
                            <p>
                                {{ .TreeData.Name }}
                                {{ .TreeData.Cname }}
                            </p>
                        </section>
                        <section class="navbar-section">
                            <a href="/tree/delete/{{ .TreeData.Treeid }}/" class="btn btn-link delete_btn" onclick="return confirm_delete();">Delete</a>
                        </section>
                    </header>

                    <!-- {{ .TreeData.Svg }} -->

                    <!-- test svg -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800.66 784.49"><defs><style>.cls-1,.cls-5,.cls-6,.cls-8,.cls-9{fill:none;}.cls-2{fill:#008490;}.cls-3{fill:#f8a6a6;}.cls-4{fill:#f8da9e;}.cls-5{stroke:#008490;}.cls-5,.cls-6,.cls-8,.cls-9{stroke-miterlimit:10;stroke-width:8px;}.cls-6{stroke:#9acace;}.cls-7{fill:#9acace;}.cls-8{stroke:#f8da9e;}.cls-9{stroke:#f8a6a6;}.cls-10{font-size:47.73px;fill:#356274;font-family:HelveticaNeue-CondensedBold, Helvetica Neue;font-weight:700;}.cls-11{letter-spacing:0.01em;}</style></defs><title>資產 1</title><g id="圖層_2" data-name="圖層 2"><g id="Object"><g id="Text"><circle class="cls-1" cx="436.62" cy="296.9" r="152.25"/><path class="cls-2" d="M584,335.14a152.29,152.29,0,0,1-295.3-2l-28.08,7.05A181.43,181.43,0,0,0,612,342.53l0-.1Z"/><path class="cls-3" d="M387.14,152.88l-8-28.88A181.54,181.54,0,0,0,258.44,330.16l28.17-7.07a152.42,152.42,0,0,1,100.52-170.2Z"/><path class="cls-4" d="M436.62,114.7A181.57,181.57,0,0,0,389,121l8,28.85A152.34,152.34,0,0,1,586.25,325.09l28.1,7.32A181.48,181.48,0,0,0,436.62,114.7Z"/><line class="cls-5" x1="173.22" y1="478.48" x2="264.23" y2="469.64"/><line class="cls-5" x1="215.23" y1="519.64" x2="259.8" y2="474.78"/><line class="cls-5" x1="434.37" y1="537.83" x2="434.64" y2="477.48"/><line class="cls-5" x1="598.94" y1="463.49" x2="562.19" y2="426.97"/><line class="cls-5" x1="666.94" y1="531.49" x2="622.08" y2="486.92"/><line class="cls-6" x1="691.23" y1="476.46" x2="603.85" y2="468.47"/><polyline class="cls-5" points="603.85 468.47 611.08 558.57 649.67 641.51"/><polyline class="cls-6" points="527.86 600.08 431.71 539.62 466.93 622.9"/><line class="cls-5" x1="400.79" y1="623.67" x2="433.24" y2="540.02"/><line class="cls-5" x1="341.09" y1="600.08" x2="431.71" y2="539.62"/><line class="cls-6" x1="718.81" y1="585.02" x2="670.02" y2="535.64"/><line class="cls-5" x1="264.23" y1="469.64" x2="308.8" y2="424.77"/><line class="cls-6" x1="256.23" y1="560.2" x2="260.64" y2="469.99"/><line class="cls-6" x1="76.83" y1="492.49" x2="173.22" y2="478.48"/><line class="cls-5" x1="145.64" y1="587.78" x2="202.06" y2="531.81"/><line class="cls-6" x1="218.72" y1="642.95" x2="256.23" y2="560.2"/><line class="cls-5" x1="308.8" y1="682.83" x2="341.09" y2="600.08"/><line class="cls-6" x1="388.4" y1="701.74" x2="400.79" y2="627.67"/><line class="cls-6" x1="466.93" y1="622.9" x2="479.79" y2="701.74"/><line class="cls-6" x1="571.36" y1="679.83" x2="527.86" y2="600.08"/><circle class="cls-2" cx="612.02" cy="557.43" r="27.58"/><circle class="cls-2" cx="670.02" cy="535.64" r="27.58"/><circle class="cls-7" cx="691.23" cy="476.46" r="27.58"/><circle class="cls-2" cx="603.85" cy="468.47" r="27.58"/><circle class="cls-2" cx="431.71" cy="539.62" r="27.58"/><circle class="cls-2" cx="264.23" cy="469.64" r="27.58"/><circle class="cls-7" cx="466.93" cy="622.9" r="27.58"/><circle class="cls-7" cx="527.86" cy="600.08" r="27.58"/><circle class="cls-2" cx="400.79" cy="623.67" r="27.58"/><circle class="cls-2" cx="341.09" cy="600.08" r="27.58"/><circle class="cls-2" cx="202.06" cy="531.81" r="27.58"/><circle class="cls-7" cx="256.23" cy="560.2" r="27.58"/><circle class="cls-7" cx="173.22" cy="478.48" r="27.58"/><circle class="cls-7" cx="78.57" cy="492.49" r="27.58"/><circle class="cls-7" cx="27.58" cy="512.03" r="27.58"/><circle class="cls-2" cx="145.64" cy="587.78" r="27.58"/><circle class="cls-2" cx="106.15" cy="627.67" r="27.58"/><circle class="cls-7" cx="66.67" cy="666.16" r="27.58"/><circle class="cls-7" cx="218.72" cy="642.95" r="27.58"/><circle class="cls-2" cx="308.8" cy="682.83" r="27.58"/><circle class="cls-2" cx="287.38" cy="735" r="27.58"/><circle class="cls-7" cx="388.4" cy="701.74" r="27.58"/><circle class="cls-7" cx="479.79" cy="701.74" r="27.58"/><circle class="cls-7" cx="486.88" cy="756.91" r="27.58"/><circle class="cls-7" cx="571.36" cy="679.83" r="27.58"/><circle class="cls-2" cx="649.67" cy="641.51" r="27.58"/><circle class="cls-2" cx="677.25" cy="689.28" r="27.58"/><circle class="cls-2" cx="705.92" cy="737.44" r="27.58"/><circle class="cls-7" cx="718.81" cy="585.02" r="27.58"/><circle id="Calculus_a1" class="cls-4" cx="599.99" cy="132.75" r="27.58"/><circle id="Calculus_a2" class="cls-4" cx="678.34" cy="119.67" r="27.58"/><line class="cls-8" x1="599.83" y1="133.75" x2="565.58" y2="168.16"/><line class="cls-8" x1="678.34" y1="119.67" x2="599.83" y2="132.13"/><line class="cls-8" x1="663.64" y1="242.77" x2="613.25" y2="254.67"/><circle id="MM" class="cls-4" cx="661.24" cy="241.67" r="27.58"/><circle class="cls-3" cx="266.72" cy="132.75" r="27.58"/><circle class="cls-3" cx="183.97" cy="105.17" r="27.58"/><circle class="cls-3" cx="239.14" cy="55.44" r="27.58"/><circle class="cls-3" cx="200.56" cy="251.14" r="27.58"/><circle class="cls-3" cx="123.06" cy="238.77" r="27.58"/><circle class="cls-3" cx="35.65" cy="223.55" r="27.58"/><polyline class="cls-9" points="35.65 223.56 123.06 238.77 200.56 251.14 258.54 261.47"/><line class="cls-9" x1="266.72" y1="134.18" x2="304.56" y2="171.75"/><line class="cls-9" x1="239.14" y1="55.44" x2="265.28" y2="132.75"/><line class="cls-9" x1="183.97" y1="105.17" x2="264.58" y2="134.18"/><text class="cls-10" transform="translate(321.18 317.59)">Jen<tspan class="cls-11" x="68.07" y="0">n</tspan><tspan x="92.41" y="0">y Hung</tspan></text><circle id="DM" class="cls-4" cx="670.03" cy="317.59" r="27.58"/><line class="cls-8" x1="658.64" y1="315.02" x2="608.25" y2="304.1"/><line class="cls-8" x1="486.88" y1="83.02" x2="464" y2="140.37"/><circle id="Statistics_I1" class="cls-4" cx="486.88" cy="77.58" r="27.58"/><circle id="Statistics_I2" class="cls-4" cx="542.16" cy="27.58" r="27.58"/><line class="cls-8" x1="542.16" y1="27.58" x2="486.83" y2="81.13"/><line class="cls-8" x1="773.08" y1="105.17" x2="542.16" y2="27.58"/><line class="cls-8" x1="773.08" y1="111.15" x2="665.83" y2="245.35"/><line class="cls-8" x1="773.08" y1="114.05" x2="679.83" y2="120.27"/><circle id="MSL_TP" class="cls-4" cx="773.08" cy="105.17" r="27.58"/></g></g></g></svg>


                    {{ .TreeData.State }}

                </main>
            </div>
        </div>
        {{ template "footer" }}
    </body>
</html>

<script>

    $(document).ready(function(){
        // setup_tree({{ .TreeData.State }});
        setup_tree("/static/test_skilltree.json");
    });

    function setup_tree(skill_tree_json){
        // var skill_tree = $.parseJSON(skill_tree_json);
        // set_node(skill_tree);
        // modify_node(skill_tree);
        $.getJSON(skill_tree_json, function(skill_tree) {
            set_node(skill_tree);
            modify_node(skill_tree);
        });
    }
    function set_node(skill_tree){
        for (var skill_id in skill_tree) {

            // Add text
            {{ if $.En }}
            $("#"+skill_id+"_name").text(skill_id);
            {{else}}
            $("#"+skill_id+"_name").text(skill_tree[skill_id]["CName"]);
            {{end}}

            // Add learned skills
            if (skill_tree[skill_id]["status"] == 1) {
                $("#"+skill_id).addClass("learned_skill");
                $("#"+skill_id+" path").style("fill","#878787");
            }
        }
    }
    function modify_node(skill_tree){
        $(".skill_node").on("click",function(){
            var this_id = $("this").attr("id");

            // Delete
            if ($("this").hasClass("learned_skill")) {
                var delete_node = confirm("Are you sure to delete the node?");
                if (delete_node == 1) {

                    // delete selected node
                    $("this").removeClass("learned_skill");
                    $("#"+this_id+" path").style("fill","#fff");
                    skill_tree[this_id]["status"] = 0;
                    for (var skill_id in skill_tree) {
                        if (
                            skill_tree[skill_id]["status"] == 1 &&
                            skill_tree[skill_id]["pre_course"].includes(this_id)
                        ) {

                            // delete course after selected node
                            $("this").removeClass("learned_skill");
                            $("#"+skill_id+" path").style("fill","#fff");
                            skill_tree[skill_id]["status"] = 0;
                        }
                    }
                    send_json(skill_tree);
                }
            }

            //Add
            else{
                // check if the node has pre_course
                finish_pre_course = 1;
                pre_course_str = "";
                skill_tree[this_id]["pre_course"].forEach(function(pre_course){
                    if (skill_tree[pre_course]["status"] == 0) {
                        finish_pre_course = 0;
                        pre_course_str += pre_course + " ";
                    }
                });

                if (finish_pre_course == 0) {
                    alert("You have to learn "+pre_course_str+"first!");
                }
                else {
                    // add node
                    $("this").addClass("learned_skill");
                    $("#"+this_id+" path").style("fill","#878787");
                    skill_tree[this_id]["status"] = 1;
                    send_json(skill_tree);
                }
            }
        })
    }

    function send_json(skill_tree) {

        // send json back to db

        // reload
        location.reload();
    }

    function confirm_delete(){
        var cancel = confirm("Are you sure to delete yout skill tree?");
        return cancel;
    }
</script>
